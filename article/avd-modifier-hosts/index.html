<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/phenomic/phenomic.main.14b1d3b9.css"/></head><body><div id="PhenomicRoot"><div data-reactroot=""><header class="header"><div class="content-wrap"><div class="logo"><h1><a href="/">Jesmo Drazik Blog</a></h1><p class="description">Développeur front-end @ Cozy Cloud</p><div class="find-me"><a href="https://twitter.com/JesmoDrazik">Twitter</a><a href="https://github.com/drazik">GitHub</a></div></div></div></header><div id="content"><div class="content-wrap"><div><article class="article"><h1 style="text-align:center">Modifier le fichier hosts d&#x27;une machine virtuelle Android</h1><div><p>Quand on veut tester un site web ou une app mobile sur un émulateur Android,
cela peut vite tourner à l&#x27;aventure. Le problème ? L&#x27;application doit pouvoir
communiquer avec l&#x27;API qui est lancée sur notre machine hôte, sur le domaine
<code>api.dev.local</code>. La solution ? La même que sur la machine hôte : modifier le
fichier <code>hosts</code> afin d&#x27;y ajouter ce domaine.</p>
<p>La plupart des réponses qu&#x27;on trouve sur le web nous suggèrent de faire un <code>adb pull</code> pour récupérer le fichier du device, de le modifier, puis de faire un
<code>adb push</code> pour le pousser sur le device. Mais ce n&#x27;est pas si simple dans la
réalité, et l&#x27;erreur suivante vous attend au tournant :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>failed to copy &#x27;hosts&#x27; to &#x27;/system/etc/hosts&#x27;: Read-only file system</span></span></div></pre>
<p>Alors comment on fait pour s&#x27;en sortir, du coup ?</p>
<h2 id="créer-un-émulateur-avec-la-bonne-image-système"><a aria-hidden="true" href="#créer-un-émulateur-avec-la-bonne-image-système"><span class="icon icon-link"></span></a>Créer un émulateur avec la bonne image système</h2>
<p>La première chose que nous allons devoir faire, c&#x27;est rooter le device. Mais ce
n&#x27;est pas possible avec toutes les images Android : seules les images &quot;Google
APIs&quot; le permettent. Les images &quot;Google Play APIs&quot; ne sont pas rootables (en
tous cas simplement avec la commande <code>adb root</code>).</p>
<p>Choisissez donc une image qui correspond à ce critère, sinon vous n&#x27;arriverez
pas à votre but.</p>
<h2 id="lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"><a aria-hidden="true" href="#lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"><span class="icon icon-link"></span></a>Lancer l&#x27;émulateur avec un système de fichier « writable »</h2>
<p>Une fois l&#x27;émulateur créé, il faut le lancer. Mais pas n&#x27;importe comment. On va
spécifier un flag qui nous permettra de rendre le système de fichier
« writable » . Pour cela, il faut localiser le binaire de votre
émulateur Android. Par défaut, il se trouve dans le dossier
<code>/home/user/Android/Sdk/emulator</code>.</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>./emulator -writable-system -avd &lt;nom de l&#x27;émulateur&gt;</span></span></div></pre>
<p>Pour connaître la liste des émulateurs que vous avez créé, c&#x27;est la commande
suivante :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>./emulator -list-avds</span></span></div></pre>
<h2 id="rooter-lémulateur"><a aria-hidden="true" href="#rooter-lémulateur"><span class="icon icon-link"></span></a>Rooter l&#x27;émulateur</h2>
<p>Pour pouvoir remonter le système de fichier en mode « writable », on doit être
root. Pour ça, il y a une commande simple :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>adb root</span></span></div></pre>
<p>Cette commande relance le daemon adb en tant que root.</p>
<h2 id="remonter-le-système-de-fichier-en-«-writable-»"><a aria-hidden="true" href="#remonter-le-système-de-fichier-en-«-writable-»"><span class="icon icon-link"></span></a>Remonter le système de fichier en « writable »</h2>
<p>Pareil qu&#x27;à l&#x27;étape précédente, une simple commande permet de faire ça :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>adb remount</span></span></div></pre>
<p>Le système de fichier de l&#x27;émulateur permet maintenant l&#x27;écriture.</p>
<h2 id="récupérer-le-fichier-hosts-de-lémulateur"><a aria-hidden="true" href="#récupérer-le-fichier-hosts-de-lémulateur"><span class="icon icon-link"></span></a>Récupérer le fichier <code>hosts</code> de l&#x27;émulateur</h2>
<p>Pour récupérer le fichier <code>hosts</code> de l&#x27;émulateur, on demande à tirer ce fichier
et à la placer quelque part sur notre machine :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>adb pull /etc/hosts hosts</span></span></div></pre>
<p>On a maintenant sur notre machine le fichier <code>hosts</code>, et on peut y apporter les
modifications souhaitées.</p>
<h2 id="ajouter-le-domaine-souhaité"><a aria-hidden="true" href="#ajouter-le-domaine-souhaité"><span class="icon icon-link"></span></a>Ajouter le domaine souhaité</h2>
<p>On souhaite lier un domaine à l&#x27;IP de notre machine hôte. Et pour ça, pas
besoin de s&#x27;ennuyer à récupérer l&#x27;IP de la machine. Non, dans un émulateur
Android, l&#x27;IP <code>10.0.2.2</code> pointe automatiquement vers la machine hôte. Vous
pouvez donc ajouter la ligne suivante au fichier <code>hosts</code> :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>10.0.2.2 api.dev.local</span></span></div></pre>
<p>En remplaçant évidemment <code>api.dev.local</code> par le domaine souhaité.</p>
<h2 id="pousser-le-nouveau-fichier-sur-lémulateur"><a aria-hidden="true" href="#pousser-le-nouveau-fichier-sur-lémulateur"><span class="icon icon-link"></span></a>Pousser le nouveau fichier sur l&#x27;émulateur</h2>
<p>Maintenant que ce fichier est à jour, il faut pousser les modifications sur
l&#x27;émulateur. Pour ça, c&#x27;est la commande suivante :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>adb push hosts /system/etc/hosts</span></span></div></pre>
<p>Pour s&#x27;assurer que tout fonctionne, on peut faire un <code>ping</code> sur le domaine
fraichement ajouté :</p>
<pre class="editor editor-colors"><div class="line"><span class="syntax--text syntax--plain syntax--null-grammar"><span>adb shell ping api.dev.local</span></span></div></pre>
<p>Et voilà !</p>
<p>Dernière précision : cette modification persistera lors des prochains
démarrage de l&#x27;émulateur. Pas besoin de taper toutes ces commandes à chaque
utilisation.</p></div><footer style="text-align:center"><a href="https://github.com/drazik/blog/edit/master/content/posts/avd-modifier-hosts/index.md" target="_blank">Proposer des modifications</a></footer></article><div><a href="/">Revenir à l&#x27;accueil</a></div></div></div></div><footer><div class="content-wrap"><section class="copy"><p>© <!-- -->2019<!-- --> Cyrille Jesmo Drazik</p></section></div></footer></div></div><script id="PhenomicHydration" type="text/json">{"path=content%2Fposts&id=avd-modifier-hosts":{"status":"idle","node":{"filename":"index.md","title":"Modifier le fichier hosts d'une machine virtuelle Android","headings":[{"level":2,"text":"Créer un émulateur avec la bonne image système","id":"créer-un-émulateur-avec-la-bonne-image-système"},{"level":2,"text":"Lancer l'émulateur avec un système de fichier « writable »","id":"lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"},{"level":2,"text":"Rooter l'émulateur","id":"rooter-lémulateur"},{"level":2,"text":"Remonter le système de fichier en « writable »","id":"remonter-le-système-de-fichier-en-«-writable-»"},{"level":2,"text":"Récupérer le fichier hosts de l'émulateur","id":"récupérer-le-fichier-hosts-de-lémulateur"},{"level":2,"text":"Ajouter le domaine souhaité","id":"ajouter-le-domaine-souhaité"},{"level":2,"text":"Pousser le nouveau fichier sur l'émulateur","id":"pousser-le-nouveau-fichier-sur-lémulateur"}],"date":"2018-03-23","body":{"t":"div","c":[{"t":"p","c":["Quand on veut tester un site web ou une app mobile sur un émulateur Android,\ncela peut vite tourner à l'aventure. Le problème ? L'application doit pouvoir\ncommuniquer avec l'API qui est lancée sur notre machine hôte, sur le domaine\n",{"t":"code","c":["api.dev.local"]},". La solution ? La même que sur la machine hôte : modifier le\nfichier ",{"t":"code","c":["hosts"]}," afin d'y ajouter ce domaine."]},"\n",{"t":"p","c":["La plupart des réponses qu'on trouve sur le web nous suggèrent de faire un ",{"t":"code","c":["adb pull"]}," pour récupérer le fichier du device, de le modifier, puis de faire un\n",{"t":"code","c":["adb push"]}," pour le pousser sur le device. Mais ce n'est pas si simple dans la\nréalité, et l'erreur suivante vous attend au tournant :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["failed to copy 'hosts' to '/system/etc/hosts': Read-only file system"]}]}]}]},"\n",{"t":"p","c":["Alors comment on fait pour s'en sortir, du coup ?"]},"\n",{"t":"h2","p":{"id":"créer-un-émulateur-avec-la-bonne-image-système"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#créer-un-émulateur-avec-la-bonne-image-système"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Créer un émulateur avec la bonne image système"]},"\n",{"t":"p","c":["La première chose que nous allons devoir faire, c'est rooter le device. Mais ce\nn'est pas possible avec toutes les images Android : seules les images \"Google\nAPIs\" le permettent. Les images \"Google Play APIs\" ne sont pas rootables (en\ntous cas simplement avec la commande ",{"t":"code","c":["adb root"]},")."]},"\n",{"t":"p","c":["Choisissez donc une image qui correspond à ce critère, sinon vous n'arriverez\npas à votre but."]},"\n",{"t":"h2","p":{"id":"lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Lancer l'émulateur avec un système de fichier « writable »"]},"\n",{"t":"p","c":["Une fois l'émulateur créé, il faut le lancer. Mais pas n'importe comment. On va\nspécifier un flag qui nous permettra de rendre le système de fichier\n« writable » . Pour cela, il faut localiser le binaire de votre\némulateur Android. Par défaut, il se trouve dans le dossier\n",{"t":"code","c":["/home/user/Android/Sdk/emulator"]},"."]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["./emulator -writable-system -avd <nom de l'émulateur>"]}]}]}]},"\n",{"t":"p","c":["Pour connaître la liste des émulateurs que vous avez créé, c'est la commande\nsuivante :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["./emulator -list-avds"]}]}]}]},"\n",{"t":"h2","p":{"id":"rooter-lémulateur"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#rooter-lémulateur"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Rooter l'émulateur"]},"\n",{"t":"p","c":["Pour pouvoir remonter le système de fichier en mode « writable », on doit être\nroot. Pour ça, il y a une commande simple :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb root"]}]}]}]},"\n",{"t":"p","c":["Cette commande relance le daemon adb en tant que root."]},"\n",{"t":"h2","p":{"id":"remonter-le-système-de-fichier-en-«-writable-»"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#remonter-le-système-de-fichier-en-«-writable-»"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Remonter le système de fichier en « writable »"]},"\n",{"t":"p","c":["Pareil qu'à l'étape précédente, une simple commande permet de faire ça :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb remount"]}]}]}]},"\n",{"t":"p","c":["Le système de fichier de l'émulateur permet maintenant l'écriture."]},"\n",{"t":"h2","p":{"id":"récupérer-le-fichier-hosts-de-lémulateur"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#récupérer-le-fichier-hosts-de-lémulateur"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Récupérer le fichier ",{"t":"code","c":["hosts"]}," de l'émulateur"]},"\n",{"t":"p","c":["Pour récupérer le fichier ",{"t":"code","c":["hosts"]}," de l'émulateur, on demande à tirer ce fichier\net à la placer quelque part sur notre machine :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb pull /etc/hosts hosts"]}]}]}]},"\n",{"t":"p","c":["On a maintenant sur notre machine le fichier ",{"t":"code","c":["hosts"]},", et on peut y apporter les\nmodifications souhaitées."]},"\n",{"t":"h2","p":{"id":"ajouter-le-domaine-souhaité"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#ajouter-le-domaine-souhaité"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Ajouter le domaine souhaité"]},"\n",{"t":"p","c":["On souhaite lier un domaine à l'IP de notre machine hôte. Et pour ça, pas\nbesoin de s'ennuyer à récupérer l'IP de la machine. Non, dans un émulateur\nAndroid, l'IP ",{"t":"code","c":["10.0.2.2"]}," pointe automatiquement vers la machine hôte. Vous\npouvez donc ajouter la ligne suivante au fichier ",{"t":"code","c":["hosts"]}," :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["10.0.2.2 api.dev.local"]}]}]}]},"\n",{"t":"p","c":["En remplaçant évidemment ",{"t":"code","c":["api.dev.local"]}," par le domaine souhaité."]},"\n",{"t":"h2","p":{"id":"pousser-le-nouveau-fichier-sur-lémulateur"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#pousser-le-nouveau-fichier-sur-lémulateur"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Pousser le nouveau fichier sur l'émulateur"]},"\n",{"t":"p","c":["Maintenant que ce fichier est à jour, il faut pousser les modifications sur\nl'émulateur. Pour ça, c'est la commande suivante :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb push hosts /system/etc/hosts"]}]}]}]},"\n",{"t":"p","c":["Pour s'assurer que tout fonctionne, on peut faire un ",{"t":"code","c":["ping"]}," sur le domaine\nfraichement ajouté :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb shell ping api.dev.local"]}]}]}]},"\n",{"t":"p","c":["Et voilà !"]},"\n",{"t":"p","c":["Dernière précision : cette modification persistera lors des prochains\ndémarrage de l'émulateur. Pas besoin de taper toutes ces commandes à chaque\nutilisation."]}]}}}}</script><script src="/phenomic/phenomic.main.14b1d3b9.js" async=""></script></body></html>
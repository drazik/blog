{"filename":"index.md","title":"Modifier le fichier hosts d'une machine virtuelle Android","headings":[{"level":2,"text":"Créer un émulateur avec la bonne image système","id":"créer-un-émulateur-avec-la-bonne-image-système"},{"level":2,"text":"Lancer l'émulateur avec un système de fichier « writable »","id":"lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"},{"level":2,"text":"Rooter l'émulateur","id":"rooter-lémulateur"},{"level":2,"text":"Remonter le système de fichier en « writable »","id":"remonter-le-système-de-fichier-en-«-writable-»"},{"level":2,"text":"Récupérer le fichier hosts de l'émulateur","id":"récupérer-le-fichier-hosts-de-lémulateur"},{"level":2,"text":"Ajouter le domaine souhaité","id":"ajouter-le-domaine-souhaité"},{"level":2,"text":"Pousser le nouveau fichier sur l'émulateur","id":"pousser-le-nouveau-fichier-sur-lémulateur"}],"date":"2018-03-23","body":{"t":"div","c":[{"t":"p","c":["Quand on veut tester un site web ou une app mobile sur un émulateur Android,\ncela peut vite tourner à l'aventure. Le problème ? L'application doit pouvoir\ncommuniquer avec l'API qui est lancée sur notre machine hôte, sur le domaine\n",{"t":"code","c":["api.dev.local"]},". La solution ? La même que sur la machine hôte : modifier le\nfichier ",{"t":"code","c":["hosts"]}," afin d'y ajouter ce domaine."]},"\n",{"t":"p","c":["La plupart des réponses qu'on trouve sur le web nous suggèrent de faire un ",{"t":"code","c":["adb pull"]}," pour récupérer le fichier du device, de le modifier, puis de faire un\n",{"t":"code","c":["adb push"]}," pour le pousser sur le device. Mais ce n'est pas si simple dans la\nréalité, et l'erreur suivante vous attend au tournant :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["failed to copy 'hosts' to '/system/etc/hosts': Read-only file system"]}]}]}]},"\n",{"t":"p","c":["Alors comment on fait pour s'en sortir, du coup ?"]},"\n",{"t":"h2","p":{"id":"créer-un-émulateur-avec-la-bonne-image-système"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#créer-un-émulateur-avec-la-bonne-image-système"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Créer un émulateur avec la bonne image système"]},"\n",{"t":"p","c":["La première chose que nous allons devoir faire, c'est rooter le device. Mais ce\nn'est pas possible avec toutes les images Android : seules les images \"Google\nAPIs\" le permettent. Les images \"Google Play APIs\" ne sont pas rootables (en\ntous cas simplement avec la commande ",{"t":"code","c":["adb root"]},")."]},"\n",{"t":"p","c":["Choisissez donc une image qui correspond à ce critère, sinon vous n'arriverez\npas à votre but."]},"\n",{"t":"h2","p":{"id":"lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#lancer-lémulateur-avec-un-système-de-fichier-«-writable-»"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Lancer l'émulateur avec un système de fichier « writable »"]},"\n",{"t":"p","c":["Une fois l'émulateur créé, il faut le lancer. Mais pas n'importe comment. On va\nspécifier un flag qui nous permettra de rendre le système de fichier\n« writable » . Pour cela, il faut localiser le binaire de votre\némulateur Android. Par défaut, il se trouve dans le dossier\n",{"t":"code","c":["/home/user/Android/Sdk/emulator"]},"."]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["./emulator -writable-system -avd <nom de l'émulateur>"]}]}]}]},"\n",{"t":"p","c":["Pour connaître la liste des émulateurs que vous avez créé, c'est la commande\nsuivante :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["./emulator -list-avds"]}]}]}]},"\n",{"t":"h2","p":{"id":"rooter-lémulateur"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#rooter-lémulateur"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Rooter l'émulateur"]},"\n",{"t":"p","c":["Pour pouvoir remonter le système de fichier en mode « writable », on doit être\nroot. Pour ça, il y a une commande simple :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb root"]}]}]}]},"\n",{"t":"p","c":["Cette commande relance le daemon adb en tant que root."]},"\n",{"t":"h2","p":{"id":"remonter-le-système-de-fichier-en-«-writable-»"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#remonter-le-système-de-fichier-en-«-writable-»"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Remonter le système de fichier en « writable »"]},"\n",{"t":"p","c":["Pareil qu'à l'étape précédente, une simple commande permet de faire ça :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb remount"]}]}]}]},"\n",{"t":"p","c":["Le système de fichier de l'émulateur permet maintenant l'écriture."]},"\n",{"t":"h2","p":{"id":"récupérer-le-fichier-hosts-de-lémulateur"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#récupérer-le-fichier-hosts-de-lémulateur"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Récupérer le fichier ",{"t":"code","c":["hosts"]}," de l'émulateur"]},"\n",{"t":"p","c":["Pour récupérer le fichier ",{"t":"code","c":["hosts"]}," de l'émulateur, on demande à tirer ce fichier\net à la placer quelque part sur notre machine :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb pull /etc/hosts hosts"]}]}]}]},"\n",{"t":"p","c":["On a maintenant sur notre machine le fichier ",{"t":"code","c":["hosts"]},", et on peut y apporter les\nmodifications souhaitées."]},"\n",{"t":"h2","p":{"id":"ajouter-le-domaine-souhaité"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#ajouter-le-domaine-souhaité"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Ajouter le domaine souhaité"]},"\n",{"t":"p","c":["On souhaite lier un domaine à l'IP de notre machine hôte. Et pour ça, pas\nbesoin de s'ennuyer à récupérer l'IP de la machine. Non, dans un émulateur\nAndroid, l'IP ",{"t":"code","c":["10.0.2.2"]}," pointe automatiquement vers la machine hôte. Vous\npouvez donc ajouter la ligne suivante au fichier ",{"t":"code","c":["hosts"]}," :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["10.0.2.2 api.dev.local"]}]}]}]},"\n",{"t":"p","c":["En remplaçant évidemment ",{"t":"code","c":["api.dev.local"]}," par le domaine souhaité."]},"\n",{"t":"h2","p":{"id":"pousser-le-nouveau-fichier-sur-lémulateur"},"c":[{"t":"a","p":{"aria-hidden":"true","href":"#pousser-le-nouveau-fichier-sur-lémulateur"},"c":[{"t":"span","p":{"class":"icon icon-link"}}]},"Pousser le nouveau fichier sur l'émulateur"]},"\n",{"t":"p","c":["Maintenant que ce fichier est à jour, il faut pousser les modifications sur\nl'émulateur. Pour ça, c'est la commande suivante :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb push hosts /system/etc/hosts"]}]}]}]},"\n",{"t":"p","c":["Pour s'assurer que tout fonctionne, on peut faire un ",{"t":"code","c":["ping"]}," sur le domaine\nfraichement ajouté :"]},"\n",{"t":"pre","p":{"class":"editor editor-colors"},"c":[{"t":"div","p":{"class":"line"},"c":[{"t":"span","p":{"class":"syntax--text syntax--plain syntax--null-grammar"},"c":[{"t":"span","c":["adb shell ping api.dev.local"]}]}]}]},"\n",{"t":"p","c":["Et voilà !"]},"\n",{"t":"p","c":["Dernière précision : cette modification persistera lors des prochains\ndémarrage de l'émulateur. Pas besoin de taper toutes ces commandes à chaque\nutilisation."]}]}}